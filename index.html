<script>
  const teamList = ["Tigers","Lions","Leopards","Jaguars","Caracals","Barbells","Gryphons","Dragons","Centaurs","Bullcats","Kestrels","Eagles","Condors","Falcons","Ospreys","Hawks","Harriers","Kites","Vultures"];
  const pointsMap = {
    "Score": 1,
    "Assist": 1,
    "Block FP": 1,
    "Swim Off win": 1,
    "Save (GK)": 1,
    "Exclusion": -1,
    "Goal Let In (GK)": -1,
    "Missed Shot (FP)": -1,
    "Cap Off": -2
  };

  let playerPoints = {}; // key: "team_cap" → value: points
  let teamPoints = { white: 0, dark: 0 };
  const actionStack = []; // Track actions for undo

  window.onload = () => {
    renderButtons();
    populateTeamDropdowns();
  }

  function populateTeamDropdowns() {
    const whiteSelect = document.getElementById("whiteTeamSelect");
    const darkSelect = document.getElementById("darkTeamSelect");

    teamList.forEach(team => {
      const whiteOption = document.createElement("option");
      whiteOption.value = whiteOption.textContent = team;
      whiteSelect.appendChild(whiteOption);

      const darkOption = document.createElement("option");
      darkOption.value = darkOption.textContent = team;
      darkSelect.appendChild(darkOption);
    });
  }

  function recordAction(team, cap, action) {
    if (!gameRunning) return;

    const gameName = document.getElementById("gameName").value;
    const whiteTeam = document.getElementById("whiteTeamSelect").value;
    const darkTeam = document.getElementById("darkTeamSelect").value;
    const quarter = document.getElementById("quarterSelect").value;
    const time = document.getElementById("gameTimer").textContent;

    const playerKey = `${team}_${cap}`;
    const points = pointsMap[action] || 0;

    playerPoints[playerKey] = (playerPoints[playerKey] || 0) + points;
    teamPoints[team] = (teamPoints[team] || 0) + points;

    const uniqueID = `${gameName}_${team}_${cap}_${action}_${Date.now()}`;

    const data = {
      gameName,
      whiteTeam,
      darkTeam,
      team,
      cap,
      action,
      time,
      quarter,
      points,
      playerTotal: playerPoints[playerKey],
      teamTotal: teamPoints[team]
    };

    sendToMakeWebhook(data);
    showToast(`${team} ${cap} – ${action} (${points >= 0 ? '+' : ''}${points} pts)`);
  }

  function sendToMakeWebhook(data) {
    fetch("https://hook.eu2.make.com/jtaf9kcqdh7kqimreichuaj3i7fi8jhr", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify(data)
    })
    .then(response => {
      if (!response.ok) throw new Error("Failed to send to Make.com");
      console.log("✅ Sent to Make.com successfully");
    })
    .catch(error => {
      console.error("❌ Error sending to Make.com:", error);
    });
  }

  let timerInterval;
  let secondsElapsed = 0;
  let gameRunning = false;

  function toggleGameState() {
    gameRunning = !gameRunning;
    const startBtn = document.getElementById("startGameBtn");
    const endBtn = document.getElementById("endGameBtn");
    startBtn.textContent = gameRunning ? "Pause Game" : "Start Game";
    endBtn.disabled = !gameRunning;

    if (gameRunning) {
      timerInterval = setInterval(() => {
        secondsElapsed++;
        const mins = String(Math.floor(secondsElapsed / 60)).padStart(2, '0');
        const secs = String(secondsElapsed % 60).padStart(2, '0');
        document.getElementById("gameTimer").textContent = `${mins}:${secs}`;
      }, 1000);
      showToast("Game started");
    } else {
      clearInterval(timerInterval);
      showToast("Game paused");
    }
  }

  function endGame() {
    gameRunning = false;
    clearInterval(timerInterval);
    document.getElementById("startGameBtn").textContent = "Start Game";
    document.getElementById("endGameBtn").disabled = true;
    secondsElapsed = 0;
    document.getElementById("gameTimer").textContent = "00:00";
    showToast("Game ended");
  }

  let lastSelectedCap = null;
  let lastSelectedTeam = null;
  const whiteScoreDisplay = document.getElementById("whiteScore");
  const darkScoreDisplay = document.getElementById("darkScore");
  let whiteScore = 0;
  let darkScore = 0;

  function selectCap(cap, team) {
    lastSelectedCap = cap;
    lastSelectedTeam = team;
    showToast(`${team === 'white' ? 'White' : 'Dark'} ${cap} selected`);
  }

  function logAction(action) {
    if (!gameRunning || lastSelectedCap === null || lastSelectedTeam === null) {
      showToast("Select a cap & start game first");
      return;
    }

    const actionData = {
      team: lastSelectedTeam,
      cap: lastSelectedCap,
      action
    };
    actionStack.push(actionData);

    if (action === "Score") {
      if (lastSelectedTeam === 'white') whiteScore++;
      else darkScore++;
      whiteScoreDisplay.textContent = whiteScore;
      darkScoreDisplay.textContent = darkScore;
    }

    recordAction(lastSelectedTeam, lastSelectedCap, action);
    showToast(`${action} logged for ${lastSelectedTeam} ${lastSelectedCap}`);
  }

  function undoLastAction() {
    if (actionStack.length === 0) {
      showToast("Nothing to undo");
      return;
    }

    const last = actionStack.pop();

    // Undo scoreboard
    if (last.action === "Score") {
      if (last.team === 'white' && whiteScore > 0) whiteScore--;
      if (last.team === 'dark' && darkScore > 0) darkScore--;
      whiteScoreDisplay.textContent = whiteScore;
      darkScoreDisplay.textContent = darkScore;
    }

    showToast(`Last action undone: ${last.team} ${last.cap} – ${last.action}`);
  }

  function renderButtons() {
    const whiteButtons = document.getElementById("whiteButtons");
    const whiteActions = document.getElementById("whiteActions");
    const darkButtons = document.getElementById("darkButtons");
    const darkActions = document.getElementById("darkActions");
    whiteButtons.innerHTML = darkButtons.innerHTML = whiteActions.innerHTML = darkActions.innerHTML = "";

    for (let i = 1; i <= 13; i++) {
      const whiteBtn = document.createElement("button");
      whiteBtn.textContent = `White ${i}`;
      whiteBtn.className = "white-button";
      whiteBtn.onclick = () => selectCap(i, 'white');
      whiteButtons.appendChild(whiteBtn);

      const darkBtn = document.createElement("button");
      darkBtn.textContent = `Dark ${i}`;
      darkBtn.className = "dark-button";
      darkBtn.onclick = () => selectCap(i, 'dark');
      darkButtons.appendChild(darkBtn);
    }

    const actions = ["Score", "Assist", "Block FP", "Swim Off win", "Save (GK)", "Exclusion", "Goal Let In (GK)", "Missed Shot (FP)", "Cap Off"];
    const types = ["positive", "positive", "positive", "positive", "positive", "negative", "negative", "negative", "negative"];

    actions.forEach((action, index) => {
      const btnWhite = document.createElement("button");
      btnWhite.textContent = action;
      btnWhite.className = types[index];
      btnWhite.onclick = () => logAction(action);
      whiteActions.appendChild(btnWhite);

      const btnDark = document.createElement("button");
      btnDark.textContent = action;
      btnDark.className = types[index];
      btnDark.onclick = () => logAction(action);
      darkActions.appendChild(btnDark);
    });
  }

  function showToast(message) {
    const toast = document.getElementById("toast");
    toast.textContent = message;
    toast.className = "show";
    setTimeout(() => { toast.className = toast.className.replace("show", ""); }, 1000);
  }
</script>
